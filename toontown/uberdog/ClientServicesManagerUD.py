from direct.distributed.DistributedObjectGlobalUD import DistributedObjectGlobalUD
from direct.directnotify.DirectNotifyGlobal import directNotify
from direct.distributed.PyDatagram import *

SHOCKLEY = "\x08\x00Shockley\x04\x00acct\x00\x00\x01\x01\x00\x0f\x00t\x05\x01\x01\x01\x01\t\x01\t\x00\r\x1a\x00\x1a\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x00\x0f\x00\x00\x00\x00\x00\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x01\x00\x00\x00\xff\x00\x00\x00\x00\x07\x00\xff\xff\xff\xff\xff\xff\xff*\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x004\x00\xe8\x03\x00\x00\xd0\x07\x00\x00\xb8\x0b\x00\x00\xa0\x0f\x00\x00\x88\x13\x00\x00p\x17\x00\x00@\x1f\x00\x00(#\x00\x00\x10'\x00\x00\xf8*\x00\x00\xe0.\x00\x00\xc82\x00\x00hB\x00\x004\x00\xe8\x03\x00\x00\xd0\x07\x00\x00\xb8\x0b\x00\x00\xa0\x0f\x00\x00\x88\x13\x00\x00p\x17\x00\x00@\x1f\x00\x00(#\x00\x00\x10'\x00\x00\xf8*\x00\x00\xe0.\x00\x00\xc82\x00\x00hB\x00\x00\x00\x00\x00\x00\x00\x00\x01\n\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x014\x00\xe8\x03\x00\x00\xd0\x07\x00\x00\xb8\x0b\x00\x00\xa0\x0f\x00\x00\x88\x13\x00\x00p\x17\x00\x00@\x1f\x00\x00(#\x00\x00\x10'\x00\x00\xf8*\x00\x00\xe0.\x00\x00\xc82\x00\x00hB\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x01e\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xd4\x07e\x00\x00\x00\xc0\x01\x08\x00\x00\x1a\x00\x01e\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xd4\x07e\x00\x00\x00\x9d\x01\x01"

class ClientServicesManagerUD(DistributedObjectGlobalUD):
    notify = directNotify.newCategory('ClientServicesManagerUD')

    def login(self, cookie):
        self.notify.debug('Received login cookie %r from %d' % (cookie, self.air.getMsgSender()))

        pdg = PyDatagram()
        pdg.addServerHeader(self.air.getMsgSender(), self.air.ourChannel, CLIENTAGENT_SET_STATE)
        pdg.addUint16(2)
        self.air.send(pdg)

        self.sendUpdateToChannel(self.air.getMsgSender(), 'acceptLogin', [])

    def requestAvatars(self):
        self.notify.debug('Received avatar list request from %d' % (self.air.getMsgSender()))

        av = [123,
              'Shockley',
              't\x05\x01\x01\x01\x01\t\x01\t\x00\r\x1a\x00\x1a\x1a',
              1,
              0]

        avs = [av]

        self.sendUpdateToChannel(self.air.getMsgSender(), 'setAvatars', [avs])

    def chooseAvatar(self, avId):
        dg = PyDatagram()
        dg.addServerHeader(self.air.getMsgSender(), self.air.ourChannel, CLIENTAGENT_SET_SENDER_ID)
        dg.addChannel((5<<32) | avId)
        self.air.send(dg)

        dg = PyDatagram()
        dg.addServerHeader(avId, self.air.ourChannel, STATESERVER_OBJECT_DELETE_RAM)
        dg.addUint32(avId)
        self.air.send(dg)

        dg = PyDatagram()
        dg.addServerHeader(self.air.serverId, self.air.ourChannel, STATESERVER_OBJECT_GENERATE_WITH_REQUIRED)
        dg.addUint32(0)
        dg.addUint32(0)
        dg.addUint16(self.air.dclassesByName['DistributedToonUD'].getNumber())
        dg.addUint32(avId)
        dg.appendData(SHOCKLEY)
        self.air.send(dg)

        dg = PyDatagram()
        dg.addServerHeader(avId, self.air.ourChannel, STATESERVER_OBJECT_SET_OWNER_RECV)
        dg.addChannel((5<<32) | avId)
        self.air.send(dg)

        self.sendUpdateToChannel(self.air.getMsgSender(), 'avatarResponse', [avId, SHOCKLEY])
